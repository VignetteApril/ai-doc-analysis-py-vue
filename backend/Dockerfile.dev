# ä½¿ç”¨å®˜æ–¹ Python è½»é‡ç‰ˆé•œåƒ
FROM python:3.10.13-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
# PYTHONDONTWRITEBYTECODE: ç¦æ­¢ Python ç”Ÿæˆ .pyc æ–‡ä»¶ï¼ˆå ç”¨ç©ºé—´ä¸”åœ¨æŒ‚è½½æ—¶å¯èƒ½å¯¼è‡´æƒé™é—®é¢˜ï¼‰
# PYTHONUNBUFFERED: å¼ºåˆ¶å°† stdout/stderr å®æ—¶è¾“å‡ºï¼Œä¸è¿›è¡Œç¼“å†²ï¼Œæ–¹ä¾¿æŸ¥çœ‹ Docker æ—¥å¿—
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿçº§ä¾èµ–
# libpq-dev: ç”¨äºè¿æ¥ PostgreSQL (psycopg2)
# build-essential: ç”¨äºç¼–è¯‘æŸäº› Python C æ‰©å±•
# curl: ç”¨äºå¥åº·æ£€æŸ¥æˆ–è°ƒè¯•
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    libreoffice \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ğŸš€ ä¼˜åŒ–ï¼šå…ˆå¤åˆ¶ requirements.txt å……åˆ†åˆ©ç”¨ Docker å±‚ç¼“å­˜
# åªè¦ requirements.txt ä¸å˜ï¼Œå†æ¬¡æ„å»ºæ—¶å°±ä¼šç›´æ¥è·³è¿‡å®‰è£…æ­¥éª¤
COPY requirements.txt .

# æ°¸ä¹…ä¿®æ”¹ pip å…¨å±€é•œåƒæº
RUN pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ && \
    pip config set install.trusted-host mirrors.aliyun.com

# å®‰è£… Python ä¾èµ–
# å¦‚æœä½ åœ¨å›½å†…å¼€å‘ï¼Œå»ºè®®åŠ ä¸Šæ¸…åæºæˆ–é˜¿é‡Œæºé•œåƒ (è§ä¸‹æ–¹è¯´æ˜)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ä¸ºä»€ä¹ˆä¸å†™ COPY . . ?
# åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬åœ¨ docker-compose é‡Œä½¿ç”¨äº† volumes æŒ‚è½½
# å®¿ä¸»æœºçš„ä»£ç ä¼šç›´æ¥è¦†ç›–å®¹å™¨å†…çš„ /app ç›®å½•ã€‚
# ä½†ä¸ºäº†å®¹å™¨çš„ç‹¬ç«‹å®Œæ•´æ€§ï¼Œåˆ›å»ºä¸€ä¸ª uploads ç›®å½•æ˜¯å¥½ä¹ æƒ¯ã€‚
RUN mkdir -p /app/uploads

# æš´éœ² FastAPI é»˜è®¤ç«¯å£
EXPOSE 8000